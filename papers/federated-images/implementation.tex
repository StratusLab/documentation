\section{Implementation}
\label{sec:implementation}

The Marketplace implementation uses standard web technologies to
create a service accessible programmatically and via a web browser.
For programmatic access, the service exposes a RESTful~\cite{rest}
interface over HTTP(S) using RESTlet~\cite{restlet}, a Java framework
for RESTful services.  HTML representations and browser interactions
are provided with a combination of FreeMarker~\cite{freemarker} (a
Java template engine library), CSS, JavaScript, and
JQuery~\cite{jquery}.

\subsection{Identifiers}

The separation of the appliance metadata and the appliance contents
requires an unambiguous mechanism for matching the two.  StratusLab
uses the SHA-1 hash of the appliance contents to generate an
unambiguous, intrinsic identifier for the image.  The identifier the
27 character string generated by encoding the SHA-1 checksum with the
base64url encoding.

\subsection{Metadata}

Semantic web technologies were designed to manage metadata about
(third-party) resources identified with a URI.  Consequently, they are
ideally suited to this situation in which the Marketplace must manage
metadata about machine and disk appliances.  These technologies already
provide standard formats for the metadata (RDF/XML~\cite{rdfxml,
  rdfprimer, rdfschema}) and query languages (SeRQL~\cite{serql},
SPARQL~\cite{sparql}).  The Marketplace implementation makes use of the
OpenRdf Sesame~\cite{sesame} framework to provide search
capabilities over the metadata database.

To validate the metadata associated with a particular appliance, it is
necessary to cryptographically sign individual entries.  As the raw
format used for the metadata entries will be XML, the XML
Signature~\cite{xmlsig} specification is reused.  This is
conveniently a standard part of modern Java runtime environments.

Working with RDF also requires an agreed vocabulary to ensure a common
semantic meaning of the metadata tags.  The Dublin Core Metadata
Initiative has published a vocabulary~\cite{dcterms} that can be used
for much of the appliance metadata descriptions.  This is complemented by
a vocabulary specific to StratusLab.  Using RDF also allows additional
metadata fields to be specified (in separate namespaces) to complement
the standard fields.

\subsection{REST Resource URLs}

The mapping between URLs and service resources is the central part of
any RESTful service.  The resource mapping must provide convenient
access via a browser but also facilitate automated interactions with
tools.  Table~\ref{table:restmap} provides the URL mapping for the
Marketplace.  (The `delete' and `put' methods are not supported by any
URLs.)  Within the table ``identifier'' refers to the 27 character
image identifier, ``email'' refers to the endorser's email address,
and ``date'' refers to endorsement date written in the format {\tt
  yyyy-MM-ddThh:mm:ssZ}.  All of the URLs support an
XML and HTML formats.  In addition single metadata entries also 
provide a JSON representation.

\begin{table}
\caption{Core REST Resources}
\label{table:restmap}
\begin{center}
\begin{tabular}{ll}

\hline
\hline

\multicolumn{2}{l}{{\tt /}} \tnl
GET & redirects to /metadata resource \tnl
\hline

\multicolumn{2}{l}{{\tt /endorsers}} \tnl
GET & list of endorsers in database \tnl
OPTIONS & number of endorsers; last update time \tnl
\hline

\multicolumn{2}{l}{{\tt /endorsers/\replaceable{email}}} \tnl
GET & statistics about particular endorser \tnl
OPTIONS & number of entries; last update time \tnl
\hline

\multicolumn{2}{l}{{\tt /metadata/?\replaceable{query}}} \tnl
GET & list of identifiers and selected fields (query terms of \tnl
    & (identifer, email, and created can be used to refine list) \tnl
POST & create new metadata entry \tnl
OPTIONS & number of entries; last update time \tnl
\hline

\multicolumn{2}{l}{{\tt /metadata/\replaceable{identifier}/\replaceable{email}/\replaceable{date}}} \tnl
GET & unique metadata entry \tnl

\multicolumn{2}{l}{\tt /metadata/query} \tnl
GET & form for simple query of service \tnl
POST & submit query \tnl
\hline

\multicolumn{2}{l}{\tt /upload} \tnl
GET & form for browser upload of metadata entry \tnl
POST & create new entry via post to /metadata \tnl

\hline
\hline

\end{tabular}
\end{center}
\end{table}

\subsection{Storage and Query of Metadata}

Metadata uploaded to the Marketplace is first validated as described
above. Once accepted, the entry is written to the filesystem in a
temporary location as an XML file. A confirmation is then sent to the
email address contained in the endorsement field of the
metadata. Assuming the endorser completes the upload by visiting the
confirmation URL contained in the email, the metadata entry is moved
to the permanent data directory. A copy of the metadata, stripped of
the XML signature is then added to the Sesame repository. Stripping of
the signature is necessary as Sesame is unable to accept the signed
metadata. Storing the metadata to the repository allows simple queries
and queries with SPARQL~\cite{sparql} to be easily supported. A
request for a specific metadata entry in XML format results in the
original signed file stored on the filesystem being returned.
