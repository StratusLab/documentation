---
layout: article
title: CloudInit Contextualization
category: documentation
---

Contextualization allows a virtual machine instance to learn about its
cloud environment (the 'context') and to configure itself to run
correctly there.  StratusLab now supports CloudInit contextualization
in addition to the OpenNebula and HEPiX contextualization schemes.

This article explains how users can send contextualization information
to the appliance and how an appliance using CloudInit can be created.


CloudInit
---------

The [CloudInit][ci-docs] mechanism is gaining traction within the
cloud ecosystem and is moving towards becoming a de facto standard for
the process.  Because it handles both web-server and disk based
contextualization mechanisms it is fairly straightforward for cloud
software developers to implement.

For the appliance developers it provides a convenient modular
framework for allowing both system and user-level service
configuration.  Being written in python with OS packages for most
systems, makes it easy for those developers to include and use the
software.

Ubuntu provides [good documentation][ci-docs] for CloudInit.  The
software itself can be downloaded from [launchpad][ci-code] or
installed from standard repositories for your operating system
(e.g. [EPEL][epel] for CentOS).


CloudInit-Enabled Images
------------------------

All of the latest versions of the base virtual machine images
maintained by StratusLab now support CloudInit.  Using one of those
images is the easiest way to see how CloudInit works.  However, you
can build your own image with CloudInit support; see the appendix of
this document for instructions.


Web Server Example
------------------

To show how users can pass CloudInit information to the appliance, we
will work through an example with the latest CentOS base image.  We
will use a script to install and configure a web server on the example
machine.  This script is generated by the user, sent via the
`stratus-run-instance` command and then executed in the machine
instance by the CloudInit contextualization.

The script that we want to execute on the machine instance is the
following: 

    #!/bin/bash -x

    yum install -y httpd 

    cat > /var/www/html/test.txt <<EOF
    SUCCESSFUL TEST
    EOF

    chkconfig httpd on 

    service httpd start

This installs, configures, and starts a web server on the machine.
We've named this script `run-http.sh`.  Create this script on the
machine where you've installed the StratusLab client commands. 

The context information must be defined and passed to the virtual
machine when starting it.  The context is defined by a set of
mimetype,file pairs:

    ssh,$HOME/.ssh/id_rsa.pub
    x-shellscript,run-http.sh

For ssh keys, use the pseudo-mimetype of 'ssh'.  A single file can be
included literally (instead of being embedded in a multipart message)
with a pseudo-mimetype of 'none'.

This information can be passed directly to `stratus-run-instance` with
the `--cloud-init` option:

    $ stratus-run-instance \
         --cloud-init \
         'ssh,$HOME/.ssh/id_rsa.pub#x-shellscript,run-http.sh' \
         ... other options ...

Note that in this case, multiple pairs are separated by a hash sign.
You can also create a `cloud-init.txt` file containing the context
information:

    $ stratus-prepare-context \
         ssh,$HOME/.ssh/id_rsa.pub \
         x-shellscript,run-http.sh

and then pass this to the `stratus-run-instance` command with the
`--context-file` option:

    $ stratus-run-instance --context-file cloud-init.txt

The first option is generally the most convenient option unless
further (non-cloud-init) options need to be passed to the virtual
machine. 

The context can contain multiple public ssh keys and multiple scripts
or other files.  See the [CloudInit documentation][ci-docs] for what
is permitted for 'user data'.

**Warning**: No ssh keys are included by default.  You must specify
explicitly any keys that you want to include. 

**Warning**: Be sure that the contextualization information you are
passing can be used by the CloudInit version within the appliance
itself.  **Be particularly careful because multipart inputs do not
work if the python version in the virtual machine is less than
2.7.3.**

This is the case with the CentOS image used here, so we'll include
the script literally in the user data with context information:

    ssh,$HOME/.ssh/id_rsa.pub
    none,run-http.sh

Note the use of the 'none' pseudo-mimetype.  If 'none' is used, only
the last file marked as 'none' will be included in the user data; it
will be included literally, that is without encapsulating it in a
multipart form.

If you use the `stratus-prepare-context` command, you can see what
key-value pairs are passed to the virtual machine.  The
`cloud-init.txt` will look like:

    CONTEXT_METHOD=cloud-init
    CLOUD_INIT_AUTHORIZED_KEYS=c3NoLXJzYS...
    CLOUD_INIT_USER_DATA=H4sIAGHZzV...

The last two parameters contain base64 encoded representations of the
ssh keys and the `run-http.sh` script.

The machine can then be started with the command:

    $ stratus-run-instance \
        --cloud-init \
        ssh,$HOME/.ssh/id_rsa.pub'#none,run-http.sh' \
        IRei7LKvxoWVRsiiup2cz3-sSsk

After this machine starts it should be possible to see the configured
file in the appliance's web server: 

    $ curl http://vm.example.org/test.txt 
    SUCCESSFUL TEST

Of course you need to change the node name to point to the machine
instance that you've started. 


Conclusions
-----------

StratusLab support for CloudInit should make it easier for users to
create appliances that will run on StratusLab as well as on other
clouds using an implementation compatible with CloudInit.  This will
be an important gain for users as they move to a federated cloud
environment. 

This preview support for CloudInit demonstrates the utility of this
contextualization method.  The collaboration is interested in hearing
your feedback on the implementation so that we can improve it in
upcoming releases.  This will likely become the default
contextualization method in a future release.


Appendix: Building an Image with CloudInit
------------------------------------------

The standard StratusLab commands for creating appliances
(e.g. `stratus-create-image`) can be used to create an appliance using
CloudInit.  See the image creation document for details on the
commands.

The following script can be fed to `stratus-create-image` to create an
example appliance with CloudInit support.  Note that all of the recent
base images maintained by StratusLab already contain CloudInit
support. 

    #!/bin/bash -x 

    #
    # Turn off udev caching of network information.
    #
    rm -f /lib/udev/rules.d/*net-gen*
    rm -f /etc/udev/rules.d/*net.rules

    #
    # Configure the machine for the EPEL repository.  The CloudInit
    # package is available from there.
    #
    wget -nd http://fr2.rpmfind.net/linux/epel/6/i386/epel-release-6-8.noarch.rpm
    yum install -y epel-release-6-8.noarch.rpm

    #
    # Upgrade all package on the machine and install cloud-init.
    yum clean all 
    yum upgrade -y 
    yum install -y cloud-init

    #
    # Change configuration to allow root access.  Signal that the 'user'
    # account should also be configured.
    #
    sed -i 's/user: ec2-user/user: root/' /etc/cloud/cloud.cfg
    sed -i 's/disable_root: 1/disable_root: 0/' /etc/cloud/cloud.cfg

This script was named `create-cloud-init-appliance.sh` for the command
to create the machine:

    $ stratus-create-image \
        -s create-cloud-init-appliance.sh \
        --type c1.medium \
        --title 'example title' \
        --comment 'example comment' \
        --author 'Jane Creator' \
        --author-email 'jane@example.org' \
        Jd3yRF6x4ofxfCeVK6BmCkuHc0m 

The image ID Jd3yRF6x4ofxfCeVK6BmCkuHc0m refers to a standard CentOS
6.2 machine without CloudInit support.  The configuration commands and
the package to be installed will depend on what base operating system
you choose.

The image generated with the above procedure will work with the
CloudInit tutorial described above.


[ci-docs]: https://help.ubuntu.com/community/CloudInit
[ci-code]: https://launchpad.net/cloud-init
[epel]: http://fedoraproject.org/wiki/EPEL
